# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SpiLoopback is an STM32F303RE Nucleo board demonstration project showcasing SPI master-slave bidirectional communication using DMA-driven transfers. A single microcontroller operates as both SPI master (SPI1) and slave (SPI3), proving independent data exchange between them.

## Build Commands

```bash
# Build the project (PLATFORM environment variable required)
PLATFORM=STM32F303 make

# Clean build artifacts
PLATFORM=STM32F303 make clean
```

Build output goes to `build.STM32F303/` and produces `SpiLoopback.elf`, `.hex`, and `.bin` files.

**Toolchain**: `arm-none-eabi-g++` targeting Cortex-M4 with hardware FPU.

## Architecture

### Hardware Configuration
- **MCU**: STM32F303RETx (Cortex-M4F, 72 MHz, 512KB Flash, 80KB RAM)
- **SPI1 (Master)**: PA4 (NSS), PB3 (SCK), PB4 (MISO), PB5 (MOSI) - 2.25 MHz clock
- **SPI3 (Slave)**: PA15 (NSS), PC10 (SCK), PC11 (MISO), PC12 (MOSI)
- **UART1 (Debug)**: PC4 (TX), PC5 (RX) - 115200 bps

Master and slave SPI pins are externally wired together for loopback testing.

### Software Architecture

```
VSrc/                   # Custom C++ application layer
├── SpiLoopback.cpp     # Main test loop (MainMasterSlave)
├── CSpiMaster.cpp      # SPI1 master wrapper with DMA
├── CSpiSlave.cpp       # SPI3 slave wrapper with DMA
├── CSerialPrint.cpp    # DMA-driven UART debug output
├── CFormattedBuffer.cpp# Printf-style message formatting
├── mySysTick.cpp       # Software timers (delay, spiDelay)
└── CHoldInterrupts.cpp # RAII interrupt management

Core/Src/               # STM32 HAL configuration (generated by CubeMX)
├── spi.c               # SPI1/SPI3 + DMA channel setup
├── dma.c               # DMA1 & DMA2 initialization
├── gpio.c              # Pin configuration
└── usart.c             # UART1 initialization
```

### Data Flow

1. `MainMasterSlave()` generates distinct test patterns: master sends `[0..127]`, slave sends `[128..1]`
2. Slave starts first (waits for master clock), then master initiates transfer
3. Both use 128-byte DMA transfers simultaneously
4. Completion callbacks verify bidirectional data integrity
5. Results output via UART serial

### Key Design Patterns
- **Singleton**: `CSpiMaster`, `CSpiSlave`, and `CSerialPrint` use factory methods for single instances
- **RAII**: `CHoldInterrupts` disables/restores interrupts for critical sections
- **DMA callbacks**: `HAL_SPI_TxRxCpltCallback` routes to registered completion handlers

## STM32CubeMX

The `SpiLoopback.ioc` file contains the pinout and peripheral configuration. Regenerating with CubeMX will update files in `Core/`.

## Documentation

- `/Docs/Startup.jpg` - Waveform capture
- `/Docs/Startup.sal` - Saleae Logic Pro capture file
- `/SpiLoopback-NUCLEO-Wiring.pdf` - Wiring schematic
